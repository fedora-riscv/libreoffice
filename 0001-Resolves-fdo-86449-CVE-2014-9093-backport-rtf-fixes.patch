From 3cc59bd5c5d2e977a8a11be48dba1282283e7f3a Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Caol=C3=A1n=20McNamara?= <caolanm@redhat.com>
Date: Wed, 20 Aug 2014 08:56:54 +0100
Subject: [PATCH] Resolves: fdo#86449 CVE-2014-9093 backport rtf fixes

The actual bug is against 3.5.4 and 4.2 doesn't crash in anything like the same
way but it does still crash. So these fixes stop the provided examples from
crashing in 4.2 on using top on an empty stack, which isn't the same as
actually being a fix for CVE-2014-9093 as seen in 3.5.X

empty Reference

valgrind + bff

(cherry picked from commit 0a42632a74596cbc781746931bf8f2650994b80f)

empty m_aStates

valgrind + bff

(cherry picked from commit e3247719911f4e9b61ec43ea1c9ce04bcddc4ff8)

3bd526b7ebf0f4fce5d0c7054809e0dc2908e73f
Reviewed-on: https://gerrit.libreoffice.org/12965
Reviewed-by: Miklos Vajna <vmiklos@collabora.co.uk>
Tested-by: Miklos Vajna <vmiklos@collabora.co.uk>

(cherry picked from commit b4840d3632e4404bee4bd192a7db916cbad3a401)

Conflicts:
	writerfilter/source/dmapper/DomainMapperTableHandler.cxx
	writerfilter/source/rtftok/rtfdocumentimpl.cxx

Resolves: fdo#86451 guard all the tops post pop

Reviewed-on: https://gerrit.libreoffice.org/12966
Reviewed-by: Miklos Vajna <vmiklos@collabora.co.uk>
Tested-by: Miklos Vajna <vmiklos@collabora.co.uk>
(cherry picked from commit 566300ebd57e6ff07fdb014321e23a92c9bcf5ee)

Conflicts:
	writerfilter/source/rtftok/rtfdocumentimpl.cxx

98be6f014893dfc7cee770c44cd9d0be32b39f5c

Change-Id: Id3c039a46dec5d2d4a4642dfb53d23a76972dde2
---
 writerfilter/source/rtftok/rtfdocumentimpl.cxx | 48 +++++++++++++++++---------
 1 file changed, 32 insertions(+), 16 deletions(-)

diff --git a/writerfilter/source/rtftok/rtfdocumentimpl.cxx b/writerfilter/source/rtftok/rtfdocumentimpl.cxx
index 64e8627..7add30b 100644
--- a/writerfilter/source/rtftok/rtfdocumentimpl.cxx
+++ b/writerfilter/source/rtftok/rtfdocumentimpl.cxx
@@ -4616,7 +4616,7 @@ int RTFDocumentImpl::popState()
         case DESTINATION_PARAGRAPHNUMBERING:
             {
                 RTFValue::Pointer_t pIdValue = aState.aTableAttributes.find(NS_rtf::LN_LSID);
-                if (pIdValue.get())
+                if (pIdValue.get() && !m_aStates.empty())
                 {
                     // Abstract numbering
                     RTFSprms aLeveltextAttributes;
@@ -4685,18 +4685,21 @@ int RTFDocumentImpl::popState()
             }
             break;
         case DESTINATION_PARAGRAPHNUMBERING_TEXTAFTER:
+            if (!m_aStates.empty())
             {
                 RTFValue::Pointer_t pValue(new RTFValue(aState.aDestinationText.makeStringAndClear(), true));
                 m_aStates.top().aTableAttributes.set(NS_ooxml::LN_CT_LevelSuffix_val, pValue);
             }
             break;
         case DESTINATION_PARAGRAPHNUMBERING_TEXTBEFORE:
+            if (!m_aStates.empty())
             {
                 RTFValue::Pointer_t pValue(new RTFValue(aState.aDestinationText.makeStringAndClear(), true));
                 m_aStates.top().aTableAttributes.set(NS_ooxml::LN_CT_LevelText_val, pValue);
             }
             break;
         case DESTINATION_LISTLEVEL:
+            if (!m_aStates.empty())
             {
                 RTFValue::Pointer_t pInnerValue(new RTFValue(m_aStates.top().nListLevelNum++));
                 aState.aTableAttributes.set(NS_ooxml::LN_CT_Lvl_ilvl, pInnerValue);
@@ -4709,6 +4712,7 @@ int RTFDocumentImpl::popState()
             }
             break;
         case DESTINATION_LFOLEVEL:
+            if (!m_aStates.empty())
             {
                 RTFValue::Pointer_t pInnerValue(new RTFValue(m_aStates.top().nListLevelNum++));
                 aState.aTableAttributes.set(NS_ooxml::LN_CT_NumLvl_ilvl, pInnerValue);
@@ -4719,6 +4723,7 @@ int RTFDocumentImpl::popState()
             break;
             // list override table
         case DESTINATION_LISTOVERRIDEENTRY:
+            if (!m_aStates.empty())
             {
                 if (m_aStates.top().nDestinationState == DESTINATION_LISTOVERRIDEENTRY)
                 {   // copy properties upwards so upper popState inserts it
@@ -4735,36 +4740,43 @@ int RTFDocumentImpl::popState()
             }
             break;
         case DESTINATION_LEVELTEXT:
+            if (!m_aStates.empty())
             {
                 RTFValue::Pointer_t pValue(new RTFValue(aState.aTableAttributes));
                 m_aStates.top().aTableSprms.set(NS_ooxml::LN_CT_Lvl_lvlText, pValue);
             }
             break;
         case DESTINATION_LEVELNUMBERS:
-            m_aStates.top().aTableSprms = aState.aTableSprms;
+            if (!m_aStates.empty())
+                m_aStates.top().aTableSprms = aState.aTableSprms;
             break;
         case DESTINATION_FIELDINSTRUCTION:
-            m_aStates.top().nFieldStatus = FIELD_INSTRUCTION;
+            if (!m_aStates.empty())
+                m_aStates.top().nFieldStatus = FIELD_INSTRUCTION;
             break;
         case DESTINATION_FIELDRESULT:
-            m_aStates.top().nFieldStatus = FIELD_RESULT;
+            if (!m_aStates.empty())
+                m_aStates.top().nFieldStatus = FIELD_RESULT;
             break;
         case DESTINATION_FIELD:
             if (aState.nFieldStatus == FIELD_INSTRUCTION)
                 singleChar(0x15);
             break;
         case DESTINATION_SHAPEPROPERTYVALUEPICT:
+            if (!m_aStates.empty())
             {
                 m_aStates.top().aPicture = aState.aPicture;
                 m_aStates.top().aDestinationText = aState.aDestinationText;
             }
             break;
         case DESTINATION_FALT:
-            m_aStates.top().aTableSprms = aState.aTableSprms;
+            if (!m_aStates.empty())
+                m_aStates.top().aTableSprms = aState.aTableSprms;
             break;
         case DESTINATION_SHAPEPROPERTYNAME:
         case DESTINATION_SHAPEPROPERTYVALUE:
         case DESTINATION_SHAPEPROPERTY:
+            if (!m_aStates.empty())
             {
                 m_aStates.top().aShape = aState.aShape;
                 m_aStates.top().aPicture = aState.aPicture;
@@ -4774,19 +4786,23 @@ int RTFDocumentImpl::popState()
         case DESTINATION_FLYMAINCONTENT:
         case DESTINATION_SHPPICT:
         case DESTINATION_SHAPE:
-            m_aStates.top().aFrame = aState.aFrame;
-            if (aState.nDestinationState == DESTINATION_SHPPICT && m_aStates.size() && m_aStates.top().nDestinationState == DESTINATION_LISTPICTURE)
+            if (!m_aStates.empty())
             {
-                RTFSprms aAttributes;
-                aAttributes.set(NS_ooxml::LN_CT_NumPicBullet_numPicBulletId, RTFValue::Pointer_t(new RTFValue(m_nListPictureId++)));
-                RTFSprms aSprms;
-                // Dummy value, real picture is already sent to dmapper.
-                aSprms.set(NS_ooxml::LN_CT_NumPicBullet_pict, RTFValue::Pointer_t(new RTFValue(0)));
-                RTFValue::Pointer_t pValue(new RTFValue(aAttributes, aSprms));
-                m_aListTableSprms.set(NS_ooxml::LN_CT_Numbering_numPicBullet, pValue, false);
+                m_aStates.top().aFrame = aState.aFrame;
+                if (aState.nDestinationState == DESTINATION_SHPPICT && m_aStates.size() && m_aStates.top().nDestinationState == DESTINATION_LISTPICTURE)
+                {
+                    RTFSprms aAttributes;
+                    aAttributes.set(NS_ooxml::LN_CT_NumPicBullet_numPicBulletId, RTFValue::Pointer_t(new RTFValue(m_nListPictureId++)));
+                    RTFSprms aSprms;
+                    // Dummy value, real picture is already sent to dmapper.
+                    aSprms.set(NS_ooxml::LN_CT_NumPicBullet_pict, RTFValue::Pointer_t(new RTFValue(0)));
+                    RTFValue::Pointer_t pValue(new RTFValue(aAttributes, aSprms));
+                    m_aListTableSprms.set(NS_ooxml::LN_CT_Numbering_numPicBullet, pValue, false);
+                }
             }
             break;
         case DESTINATION_TITLE:
+            if (!m_aStates.empty())
             {
                 if (m_aStates.top().nDestinationState == DESTINATION_TITLE)
                     // The parent is a title as well, just append what we have so far.
@@ -4797,7 +4813,7 @@ int RTFDocumentImpl::popState()
             break;
         case DESTINATION_SHAPETEXT:
             // If we're leaving the shapetext group (it may have nested ones) and this is a shape, not an old drawingobject.
-            if (m_aStates.top().nDestinationState != DESTINATION_SHAPETEXT && !m_aStates.top().aDrawingObject.bHadShapeText)
+            if (!m_aStates.empty() && m_aStates.top().nDestinationState != DESTINATION_SHAPETEXT && !m_aStates.top().aDrawingObject.bHadShapeText)
             {
                 m_aStates.top().bHadShapeText = true;
                 m_pSdrImport->close();
@@ -4805,7 +4821,7 @@ int RTFDocumentImpl::popState()
             break;
         default:
             {
-                if (m_aStates.size() && m_aStates.top().nDestinationState == DESTINATION_PICT)
+                if (!m_aStates.empty() && m_aStates.top().nDestinationState == DESTINATION_PICT)
                     m_aStates.top().aPicture = aState.aPicture;
             }
             break;
-- 
1.9.3

