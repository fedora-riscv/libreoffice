From 5f3380777a8f6ae050890a0f1df7857f7d85470a Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Caol=C3=A1n=20McNamara?= <caolanm@redhat.com>
Date: Sun, 5 Jul 2015 16:13:03 +0100
Subject: [PATCH] ppc64: fix infinite loop with default unsigned char

(cherry picked from commit d6db7e20d31280547ab15455ad1bc2a6d84ca76e)

Change-Id: I4c1d4c9228113bf83e8aabb50f153d2658c3cf59
---
 filter/source/graphicfilter/ipsd/ipsd.cxx | 47 +++++++++++++++++++++++++------
 1 file changed, 39 insertions(+), 8 deletions(-)

diff --git a/filter/source/graphicfilter/ipsd/ipsd.cxx b/filter/source/graphicfilter/ipsd/ipsd.cxx
index 95b9e93..bae2c0b 100644
--- a/filter/source/graphicfilter/ipsd/ipsd.cxx
+++ b/filter/source/graphicfilter/ipsd/ipsd.cxx
@@ -338,7 +338,7 @@ bool PSDReader::ImplReadHeader()
 bool PSDReader::ImplReadBody()
 {
     sal_uLong       nX, nY;
-    char        nRunCount = 0;
+    signed char nRunCount = 0;
     signed char nBitCount = -1;
     sal_uInt8       nDat = 0, nDummy, nRed, nGreen, nBlue;
     BitmapColor aBitmapColor;
@@ -353,7 +353,11 @@ bool PSDReader::ImplReadBody()
                 if ( nBitCount == -1 )
                 {
                     if ( mbCompression )    // else nRunCount = 0 -> so we use only single raw packets
-                        m_rPSD.ReadChar( nRunCount );
+                    {
+                        char nTmp(0);
+                        m_rPSD.ReadChar(nTmp);
+                        nRunCount = nTmp;
+                    }
                 }
                 if ( nRunCount & 0x80 )     // a run length packet
                 {
@@ -406,7 +410,11 @@ bool PSDReader::ImplReadBody()
             while ( nY < mpFileHeader->nRows )
             {
                 if ( mbCompression )        // else nRunCount = 0 -> so we use only single raw packets
-                    m_rPSD.ReadChar( nRunCount );
+                {
+                    char nTmp(0);
+                    m_rPSD.ReadChar(nTmp);
+                    nRunCount = nTmp;
+                }
 
                 if ( nRunCount & 0x80 )     // a run length packet
                 {
@@ -455,7 +463,12 @@ bool PSDReader::ImplReadBody()
             while ( nY < mpFileHeader->nRows )
             {
                 if ( mbCompression )        // else nRunCount = 0 -> so we use only single raw packets
-                    m_rPSD.ReadChar( nRunCount );
+                {
+                    char nTmp(0);
+                    m_rPSD.ReadChar(nTmp);
+                    nRunCount = nTmp;
+                }
+
 
                 if ( nRunCount & 0x80 )     // a run length packet
                 {
@@ -496,7 +509,12 @@ bool PSDReader::ImplReadBody()
             while ( nY < mpFileHeader->nRows )
             {
                 if ( mbCompression )
-                    m_rPSD.ReadChar( nRunCount );
+                {
+                    char nTmp(0);
+                    m_rPSD.ReadChar(nTmp);
+                    nRunCount = nTmp;
+                }
+
                 if ( nRunCount & 0x80 )     // a run length packet
                 {
                     m_rPSD.ReadUChar( nGreen );
@@ -538,7 +556,12 @@ bool PSDReader::ImplReadBody()
             while ( nY < mpFileHeader->nRows )
             {
                 if ( mbCompression )
-                    m_rPSD.ReadChar( nRunCount );
+                {
+                    char nTmp(0);
+                    m_rPSD.ReadChar(nTmp);
+                    nRunCount = nTmp;
+                }
+
                 if ( nRunCount & 0x80 )     // a run length packet
                 {
                     m_rPSD.ReadUChar( nBlue );
@@ -584,7 +607,11 @@ bool PSDReader::ImplReadBody()
                 while ( nY < mpFileHeader->nRows )
                 {
                     if ( mbCompression )        // else nRunCount = 0 -> so we use only single raw packets
-                        m_rPSD.ReadChar( nRunCount );
+                    {
+                        char nTmp(0);
+                        m_rPSD.ReadChar(nTmp);
+                        nRunCount = nTmp;
+                    }
 
                     if ( nRunCount & 0x80 )     // a run length packet
                     {
@@ -669,7 +696,11 @@ bool PSDReader::ImplReadBody()
         while ( nY < mpFileHeader->nRows )
         {
             if ( mbCompression )        // else nRunCount = 0 -> so we use only single raw packets
-                m_rPSD.ReadChar( nRunCount );
+            {
+                char nTmp(0);
+                m_rPSD.ReadChar(nTmp);
+                nRunCount = nTmp;
+            }
 
             if ( nRunCount & 0x80 )     // a run length packet
             {
-- 
2.4.0

