From 98dedb1abb5197ca9bf823ddbcf0b0e55a260505 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Caol=C3=A1n=20McNamara?= <caolanm@redhat.com>
Date: Tue, 15 Dec 2015 12:35:05 +0000
Subject: [PATCH] rhbz#1283420: cairo text + xrender bodge

Change-Id: I926881bcfa4911f3d7f4899711be44a2f6d82026
---
 vcl/unx/generic/gdi/x11cairotextrender.cxx | 18 ++++++++++++++++++
 1 file changed, 18 insertions(+)

diff --git a/vcl/unx/generic/gdi/x11cairotextrender.cxx b/vcl/unx/generic/gdi/x11cairotextrender.cxx
index 8734526..17cb462 100644
--- a/vcl/unx/generic/gdi/x11cairotextrender.cxx
+++ b/vcl/unx/generic/gdi/x11cairotextrender.cxx
@@ -78,6 +82,20 @@ cairo_t* X11CairoTextRender::getCairoContext()
 
     cairo_t *cr = cairo_create(surface);
     cairo_surface_destroy(surface);
+
+    //rhbz#1283420 bodge to draw and undraw something which has the side effect
+    //of making the mysterious xrender related problem go away
+    if (cairo_version() >= CAIRO_VERSION_ENCODE(1, 10, 0))
+    {
+        cairo_surface_t *target = cairo_get_target(cr);
+        cairo_surface_t *throw_away = cairo_surface_create_similar(target, cairo_surface_get_content(target), 1, 1);
+        cairo_t *force_read_cr = cairo_create(throw_away);
+        cairo_set_source_surface(force_read_cr, target, 0, 0);
+        cairo_paint(force_read_cr);
+        cairo_destroy(force_read_cr);
+        cairo_surface_destroy(throw_away);
+    }
+
     return cr;
 }
 
-- 
2.5.0

