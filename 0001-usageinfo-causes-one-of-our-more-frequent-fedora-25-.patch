From 734411a78cc1473e449b231f63bcafdb3215a057 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Caol=C3=A1n=20McNamara?= <caolanm@redhat.com>
Date: Fri, 2 Dec 2016 14:21:46 +0000
Subject: [PATCH] usageinfo causes one of our more frequent fedora 25 crashes

https://retrace.fedoraproject.org/faf/problems/bthash/?bth=17ba9a57f40d5ca29778866a9f96c1c0dfc7593c&bth=2f1801e44e9cb0be2b013624521fb0959dc2c73a&bth=5e8a1e07503f53b13b3a6779084f8b0637aaf5a7&bth=8033013a2ce586bccc23245583fa86ef4a761dce&bth=975271167132418534cb07336601efb5b0c711f0&bth=de75c2ad7917bc889d6307b152f79d34e79ce74d

Change-Id: Ie93afa476eca9fdbf7ea17ff0189fbaa493a5531
(cherry picked from commit a064f1226b9864f0d0ef6d969f2ae53cc413eb51)
---
 sfx2/source/control/unoctitm.cxx | 12 ++++++++++--
 1 file changed, 10 insertions(+), 2 deletions(-)

diff --git a/sfx2/source/control/unoctitm.cxx b/sfx2/source/control/unoctitm.cxx
index 7ed25a4..5fa526b 100644
--- a/sfx2/source/control/unoctitm.cxx
+++ b/sfx2/source/control/unoctitm.cxx
@@ -452,6 +452,9 @@ class UsageInfo {
     /// Command vs. how many times it was used
     UsageMap maUsage;
 
+    /// config path, get it long before atexit time
+    OUString msConfigPath;
+
 public:
     UsageInfo() : mbIsCollecting(false)
     {
@@ -469,7 +472,12 @@ public:
     void save();
 
     /// Modify the flag whether we are collecting.
-    void setCollecting(bool bIsCollecting) { mbIsCollecting = bIsCollecting; }
+    void setCollecting(bool bIsCollecting)
+    {
+        mbIsCollecting = bIsCollecting;
+        if (mbIsCollecting)
+            msConfigPath = SvtPathOptions().GetConfigPath();
+    }
 };
 
 void UsageInfo::increment(const OUString &rCommand)
@@ -487,7 +495,7 @@ void UsageInfo::save()
     if (!mbIsCollecting)
         return;
 
-    OUString path(SvtPathOptions().GetConfigPath());
+    OUString path(msConfigPath);
     path += "usage/";
     osl::Directory::createPath(path);
 
-- 
2.9.3

